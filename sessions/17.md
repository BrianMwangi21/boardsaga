### Session 17 - Phase 6: Stockfish Integration (Session Handoff)

**Date**: December 30, 2025

**Summary**:
- Session 16 completed Stockfish client integration and replaced LLM-based narrative analysis with Stockfish-based analysis
- Engine analysis now working (server logs show `evaluations: Map(9)` with full data)
- **CRITICAL BUG**: MongoDB stores `evaluations` as empty object `{}` despite server having Map data
- LLM still hallucinates move notations (e.g., "Nf3" instead of "Nc3", "unknown" for final move)
- FEN positions are accurate (using actual game moves)
- Narrative analysis is deterministic (no LLM hallucinations)
- Committed: `75132b5` - session save of Map serialization work

**Root Cause Analysis**:
1. **Type Mismatch**: `GameEngineData.evaluations` is `Map<number, MoveAnalysis>` in browser
2. **MongoDB Limitation**: MongoDB stores objects, not native Maps. When saving, Map converts to `{}`
3. **Type Guard Failure**: `engineData.evaluations instanceof Map` check fails when data comes from MongoDB (it's a plain object, not a Map instance)
4. **Move Validation Fails**: `fixChessBoardsInStory()` receives empty Record, can't fix hallucinated moves
5. **Circular Problem**: We try to serialize Map → Object for MongoDB, then when reading back, the type guard `instanceof Map` fails, so the Record has numeric string keys that need special parsing

**What Was Tried**:

1. **Map → Object Serialization** (app/api/stories/route.ts):
   ```typescript
   evaluations: analysis.engineData.evaluations instanceof Map
     ? Object.fromEntries(analysis.engineData.evaluations.entries())
     : analysis.engineData.evaluations as Record<string, unknown>
   ```
   ❌ Result: Still stores `{}` in MongoDB

2. **Type Union in GameEngineData** (lib/stockfish-client.ts):
   ```typescript
   evaluations: Map<number, MoveAnalysis> | Record<number, MoveAnalysis>
   ```
   ❌ Issue: TypeScript can't access `.size`, `.entries()`, etc. on union type

3. **Helper Functions** (lib/engine-analyzer.ts):
   ```typescript
   export function getEvaluationsCount(engineData: GameEngineData | null): number
   export function getEvaluationsEntries(engineData: GameEngineData | null): [number, MoveAnalysis][]
   ```
   ❌ Issue: TypeScript errors because union type doesn't have Map methods

4. **Type Guards Everywhere**:
   - `engineData.evaluations instanceof Map` checks fail
   - `Object.entries(engineData.evaluations)` has numeric string keys (`"0"`, `"1"`, ...)
   - `parseInt(k)` fails on numeric strings vs numbers

**Files Modified**:
- `lib/engine-analyzer.ts` - Added helper functions (but with TypeScript errors)
- `lib/stockfish-client.ts` - Changed interface to use union type
- `app/api/analyze-game/route.ts` - Added console.log for debugging
- `app/api/generate-story/route.ts` - Updated to use helper imports
- `app/page.tsx` - Increased timeout to 60s, lowered depth to 5
- `app/api/stories/route.ts` - Map serialization attempt (spread operator issue)

**Current Behavior**:
```
[Server logs show]
evaluations: Map(9) {
  0 => { san: 'e4', evaluation: [Object], classification: 'inaccuracy' },
  1 => { san: 'e5', evaluation: [Object], classification: 'good' },
  ...
}

[MongoDB stores]
"evaluations": {}
```

**What the Next Agent Needs to Do**:

## Option 1: Use Array Instead of Map (Simplest Fix)

Change `GameEngineData.evaluations` from `Map` to `Array`:

```typescript
// lib/stockfish-client.ts
export interface GameEngineData {
  pgnHash: string;
  positions: PositionData[];
  evaluations: Array<MoveAnalysis>;  // Changed from Map to Array
  keyPositions: number[];
}

// lib/engine-analyzer.ts
function getEvaluationsEntries(engineData: GameEngineData | null): Array<MoveAnalysis> {
  return engineData?.evaluations || [];
}

// app/api/stories/route.ts - Simplest save
const storyDoc = {
  rawPGN: normalizedPGN,
  analysis: {
    ...analysis,
    engineData: analysis.engineData  // Direct assignment, no conversion needed
  },
  story,
  createdAt,
  updatedAt,
};
```

✅ **Pros**:
- Arrays serialize natively to MongoDB (no empty `{}` issue)
- No type guards needed
- No Map ↔ Object conversion
- Move validation works immediately

❌ **Cons**:
- O(1) space for storing (n evaluations for 100 moves)
- Linear lookup instead of O(1) Map lookup

## Option 2: Store as Object with Numeric String Keys

Keep `Map<number, MoveAnalysis>` but serialize properly:

```typescript
// When saving to MongoDB
const storyDoc = {
  analysis: {
    ...analysis,
    engineData: analysis.engineData ? {
      ...analysis.engineData,
      evaluations: Object.fromEntries(
        (analysis.engineData.evaluations as Map<number, MoveAnalysis>).entries()
          .map(([k, v]) => [String(k), v])  // Convert number keys to strings
      )
    } : undefined
  },
  // ...
};

// When reading from MongoDB
const engineMap = new Map(
  Object.entries(engineData.evaluations || {})
    .map(([k, v]) => [Number(k), v])  // Convert back to numbers
);
```

✅ **Pros**: Maintains Map structure, O(1) lookup
❌ **Cons**: Still has serialization complexity

## Option 3: MongoDB with Native Map Support

Use MongoDB BSON types to store Maps natively:

```typescript
import { Map } from 'bson';

// In GameEngineData
evaluations: Map<number, MoveAnalysis>;  // BSON Map type

// Save directly
await db.collection('stories').insertOne({
  analysis: {
    engineData: {
      evaluations: new Map(evaluations)  // BSON Map
    }
  }
});
```

✅ **Pros**: True Map support, efficient
❌ **Cons**: Requires MongoDB driver changes, more complex

## Recommendation: **Use Option 1 (Array)**

For this use case (9 moves, ~100-150 moves typical), arrays are:
- Space efficient (small overhead)
- Easy to debug
- No serialization issues
- Simple type system
- Fast enough for move validation (linear search through array)

The `O(1)` lookup concern is minimal since we only iterate during story generation, not during game analysis.

**TypeScript Errors That Need Fixing**:

All files currently have TypeScript errors from trying to use `Map | Record` union type with `.size`, `.entries()`, `.forEach()` methods:

1. **lib/engine-analyzer.ts** - Lines 80-340 have errors on union type
2. **app/api/analyze-game/route.ts** - Import errors for helper functions
3. **app/api/generate-story/route.ts** - Errors from using Map methods on union
4. **app/page.tsx** - Error: Overload 1 of 2 for `.entries()` on union type
5. **lib/stockfish-client.ts** - Duplicate function/identifier warnings
6. **app/api/stories/route.ts** - Possibly undefined errors

**How to Fix These**:

1. **Remove union type from GameEngineData interface** - just use `Map`
2. **Revert engine-analyzer.ts to working state** (git checkout)
3. **Implement Option 1** - Change `evaluations` from Map to Array

**Files to Modify**:
1. `lib/stockfish-client.ts` - Revert union type, use plain `Map`
2. `lib/engine-analyzer.ts` - Revert and update for Array instead of Map
3. `app/api/stories/route.ts` - Simplify to direct assignment (no Map conversion needed)
4. `app/api/analyze-game/route.ts` - Remove helper imports, direct access
5. `app/api/generate-story/route.ts` - Remove helper imports, work with Array

**Testing Steps After Fix**:
1. Upload same PGN file (Magnus vs Andrew Tang)
2. Check MongoDB stored data has `evaluations` array with all 9 entries
3. Check story generated has correct move notations (Nc3, not Nf3; Bb3, not unknown)
4. Verify no TypeScript errors

**Git Reference**: Commit `75132b5` has working state before type changes
