# BoardSaga Development Session

## Date
2026-01-01

## Overview
Fixed critical cache collision bug where different chess games were generating identical stories. Issue was weak hash function causing cache keys to collide.

## Problem Analysis

### User Report
- User uploaded two different PGN files:
  1. Magnus Carlsen vs Andrew Tang (2023.07.20) - 9 moves, incomplete
  2. TheTuraib vs Fleetmaster1961 (2025.10.11) - 73 moves, complete with checkmate
- Both generated **identical stories** with same ID: `story-1767288822534-a9ts6z2om`
- Same title: "The Dance of Shadows: A Chessboard War of Tactics and Sacrifice"
- Story described moves (14, 35, 37, 48, 59) that didn't exist in first game

### Root Cause
The `generateHashFromObject()` function in `lib/cache.ts` was creating weak hash keys:
```typescript
export function generateHashFromObject(obj: unknown): string {
  return Buffer.from(JSON.stringify(obj)).toString('base64').slice(0, 32)
}
```

**Issues**:
- Took only first 32 characters of base64-encoded JSON
- Similar game analysis structures easily collided
- No cryptographic guarantee of uniqueness
- Two completely different games shared same cached story

### Impact
- Different games returned same story content
- Cache defeats purpose - should optimize for identical games, not cause collisions
- User experience: confusing and misleading results

## Solution

### Implementation
Replaced weak hash with SHA-256 cryptographic hash:
```typescript
import { createHash } from 'crypto'

export function generateHash(input: string): string {
  return createHash('sha256').update(input).digest('hex')
}

export function generateHashFromObject(obj: unknown): string {
  return generateHash(JSON.stringify(obj))
}
```

**Benefits**:
- SHA-256 provides 64-character hexadecimal hash
- Cryptographically unique with extremely low collision probability
- Fixed-length output (64 chars vs variable base64 slice)
- Industry-standard approach for cache keys

### Testing
After fix, re-uploading same PGNs should generate:
- Different story IDs
- Different narratives reflecting actual game moves
- Different chapter structures and move references

## Files Modified
1. `lib/cache.ts` - Replaced weak hash with SHA-256

## Commit
- Hash: `pending`
- Message: "Fix cache collision bug - replace weak hash with SHA-256"

## Outcome
Bug **FIXED**. Different chess games will now generate unique stories. Cache still optimizes for identical games but no longer causes collisions between different games.

**Root Cause**: Weak hash function (first 32 chars of base64)
**Solution**: SHA-256 cryptographic hash
**Impact**: High - affected all story generation with caching
